# Configuración Mínima de Nginx para Proxy Inverso con Balanceo de Carga

events {
    # El valor por defecto (1024) es suficiente para la mayoría de los casos.
    # No se requieren más ajustes aquí.
}

http {
    # ====================================================
    # 1. UPSTREAM (Balanceo de Carga - Round Robin)
    # ====================================================
    # Define el pool de servidores de la aplicación web
    upstream backend_app {
        # El método Round Robin es el predeterminado.
        server web:8000;
        # Si escala, simplemente añade: server web2:8000;
    }

    # ====================================================
    # 2. SERVER BLOCK (Proxy Inverso)
    # ====================================================
    server {
        listen 80;
        # server_name _: Acepta cualquier nombre de host
        server_name _; 

        # --------------------------------------------------
        # A. Archivos estáticos (Máximo rendimiento)
        # --------------------------------------------------
        # Nginx sirve directamente el contenido de /app/app/static/
        location /static/ {
            alias /app/app/static/;
            expires 30d; # Cacheo agresivo de estáticos en el navegador
        }

        # --------------------------------------------------
        # B. Contenido Dinámico (Proxy a Flask/Gunicorn)
        # --------------------------------------------------
        location / {
            # Establece la conexión con el upstream (el pool de servidores)
            proxy_pass http://backend_app;

            # Headers esenciales para que la aplicación vea la IP real del cliente
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Timeout reducido a 30s (Suficiente para la mayoría de llamadas al INE)
            proxy_read_timeout 30s;
        }
    }
}